/* 
 * angular-joint-erd - v1.0.0 - 2016-10-21
 * http://www.acorn.ro
 * Radu Nicoara <radu.nicoara@acorn.ro>
 * Copyright (c) 2016 Acorn IT; Licensed MIT 
 */
function loadDiagram(a,b,c){var d={};b.tables.forEach(function(a){d[a.name]=getUmlClass(a,c)}),_.each(d,function(b){a.addCell(b)});var e=getRelations(d,b,c);_.each(e,function(b){a.addCell(b)}),joint.layout.DirectedGraph.layout(a,{setLinkVertices:!1,marginX:20,marginY:20,nodeSep:200,rankSep:200})}function getRelations(a,b,c){var d={text:{fill:"white","font-family":"sans-serif"},rect:{stroke:"#31d0c6","stroke-width":20}};return c&&Object.keys(c).forEach(function(a){switch(a){case"linkLabelText":$.extend(d.text,c[a]);break;case"linkLabelRect":$.extend(d.rect,c[a])}}),b.relations.map(function(b){return d.text.text=b.name,new joint.shapes.uml.Generalization({source:{id:a[b.parent].id},target:{id:a[b.child].id},router:{name:"manhattan"},connector:{name:"rounded"},labels:[{position:.45,attrs:d}]})})}function getUmlClass(a,b){var c={".uml-class-name-rect":{fill:"#ff8450",stroke:"#fff","stroke-width":.5},".uml-class-name-text":{},".uml-class-attrs-rect":{fill:"#fe976a",stroke:"#fff","stroke-width":.5,"text-align":"middle"},".uml-class-methods-rect":{fill:"#fe976a",stroke:"#fff","stroke-width":.5,"text-align":"middle"},".uml-class-attrs-text":{ref:".uml-class-attrs-rect","ref-y":.5,"y-alignment":"middle","font-size":"12px","text-align":"middle"},".uml-class-methods-text":{ref:".uml-class-methods-rect","ref-y":.5,"y-alignment":"middle"}};return b&&Object.keys(b).forEach(function(a){switch(a){case"tableHeader":$.extend(c[".uml-class-name-rect"],b[a]);break;case"tableHeaderText":$.extend(c[".uml-class-name-text"],b[a]);break;case"tableProperties":$.extend(c[".uml-class-attrs-rect"],b[a]);break;case"tablePropertiesText":$.extend(c[".uml-class-attrs-text"],b[a]);break;case"tableIndexes":$.extend(c[".uml-class-methods-rect"],b[a]);break;case"tableIndexesText":$.extend([".uml-class-methods-text"],b[a])}}),new joint.shapes.uml.Class({size:{width:200,height:100},name:a.name,attributes:a.fields&&a.fields.map(function(a){return a.name+" : "+a.type}),methods:a.indexes&&a.indexes.map(function(a){return a.field+" : "+a.direction}),attrs:c})}angular.module("angular-joint-erd",[]).directive("diagram",function(){return{restrict:"E",scope:{structure:"=ngModel",styleOpts:"=styling"},template:'<div style="overflow: auto; height: 100%; width: 100%;" class="diagram-wrapper"><div class="dgr-elem"></div></div>',link:function(a,b,c){if(!jQuery)throw new Error("angular-joint.js requires that jQuery be previously loaded");var d=Date.now(),e=$(b).find(".diagram-wrapper");e.attr("id",d);var f=e.find(".dgr-elem");if(!joint)throw new Error("angular-joint.js requires that joint.js be loaded");var g=a.structure,h=new joint.dia.Graph,i=(new joint.dia.Paper({el:f,width:"100%",height:"99%",model:h,gridSize:1}),_.debounce(function(){var a=$("g#v-3").get(0).getBBox().height+100,b=$("g#v-3").get(0).getBBox().width+100,c=$(e).height(),d=$(e).width();$(f).css("height",a>c?a:"100%"),$(f).css("width",b>d?b:"100%")},500));h.on("change",function(){i()});var j=a.styleOpts;loadDiagram(h,g,j),$(window).on("resize",i)}}});